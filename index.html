<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Alarm - Walk to Dismiss</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 100%);
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }

    .container {
      text-align: center;
      max-width: 400px;
      width: 100%;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: #94a3b8;
    }

    .pairing-section {
      margin-bottom: 30px;
    }

    .pairing-label {
      font-size: 0.9rem;
      color: #64748b;
      margin-bottom: 15px;
    }

    .code-input-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .code-digit {
      width: 60px;
      height: 70px;
      font-size: 2rem;
      text-align: center;
      background: rgba(0,0,0,0.3);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      color: white;
      font-family: monospace;
    }

    .code-digit:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .connect-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
    }

    .connect-btn:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }

    .connect-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
    }

    /* Connected/Tracking State */
    .tracking-section {
      display: none;
    }

    .tracking-section.active {
      display: block;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      border-radius: 20px;
      color: #4ade80;
      font-size: 0.9rem;
      margin-bottom: 30px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4ade80;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .distance-circle {
      width: 220px;
      height: 220px;
      border-radius: 50%;
      background: conic-gradient(
        #4ade80 var(--progress, 0%),
        rgba(255,255,255,0.1) var(--progress, 0%)
      );
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 30px;
      position: relative;
    }

    .distance-circle::before {
      content: '';
      position: absolute;
      width: 190px;
      height: 190px;
      border-radius: 50%;
      background: linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 100%);
    }

    .distance-inner {
      position: relative;
      z-index: 1;
      text-align: center;
    }

    .distance-value {
      font-size: 3.5rem;
      font-weight: 700;
      color: #4ade80;
      line-height: 1;
    }

    .distance-unit {
      font-size: 1.2rem;
      color: #64748b;
    }

    .target-text {
      font-size: 1rem;
      color: #94a3b8;
      margin-bottom: 20px;
    }

    .target-value {
      color: #3b82f6;
      font-weight: 600;
    }

    .gps-info {
      font-size: 0.85rem;
      color: #64748b;
      margin-top: 20px;
    }

    .gps-accuracy {
      color: #fbbf24;
    }

    /* Error state */
    .error-message {
      padding: 15px;
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.3);
      border-radius: 12px;
      color: #f87171;
      margin-top: 20px;
      font-size: 0.9rem;
    }

    /* Success state */
    .success-section {
      display: none;
    }

    .success-section.active {
      display: block;
    }

    .success-icon {
      font-size: 5rem;
      margin-bottom: 20px;
    }

    .success-text {
      font-size: 2rem;
      color: #4ade80;
      margin-bottom: 10px;
    }

    .success-subtext {
      font-size: 1rem;
      color: #94a3b8;
      line-height: 1.6;
    }

    /* Keep screen on notice */
    .screen-notice {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      padding: 12px;
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.3);
      border-radius: 10px;
      color: #fbbf24;
      font-size: 0.85rem;
      text-align: center;
    }

    .screen-notice.success {
      background: rgba(74, 222, 128, 0.1);
      border-color: rgba(74, 222, 128, 0.3);
      color: #4ade80;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Pairing Section -->
    <div class="pairing-section" id="pairingSection">
      <h1>Walk to Dismiss Alarm</h1>
      <p class="pairing-label">Enter the code shown on your computer:</p>

      <div class="code-input-container">
        <input type="text" class="code-digit" id="digit1" maxlength="1" inputmode="numeric" pattern="[0-9]*">
        <input type="text" class="code-digit" id="digit2" maxlength="1" inputmode="numeric" pattern="[0-9]*">
        <input type="text" class="code-digit" id="digit3" maxlength="1" inputmode="numeric" pattern="[0-9]*">
        <input type="text" class="code-digit" id="digit4" maxlength="1" inputmode="numeric" pattern="[0-9]*">
      </div>

      <button class="connect-btn" id="connectBtn" disabled>Connect</button>

      <div class="error-message" id="pairingError" style="display: none;"></div>
    </div>

    <!-- Tracking Section -->
    <div class="tracking-section" id="trackingSection">
      <div class="status-badge">
        <div class="status-dot"></div>
        <span>Tracking</span>
      </div>

      <div class="distance-circle" id="distanceCircle" style="--progress: 0%;">
        <div class="distance-inner">
          <div class="distance-value" id="distanceValue">0</div>
          <div class="distance-unit">meters</div>
        </div>
      </div>

      <p class="target-text">
        Walk <span class="target-value" id="targetValue">100</span>m to dismiss the alarm
      </p>

      <div class="gps-info">
        GPS Accuracy: <span class="gps-accuracy" id="gpsAccuracy">--</span>m
      </div>

      <div class="error-message" id="trackingError" style="display: none;"></div>
    </div>

    <!-- Success Section -->
    <div class="success-section" id="successSection">
      <div class="success-icon">&#127774;</div>
      <div class="success-text">Great job!</div>
      <p class="success-subtext">
        You walked the distance. The alarm has been dismissed.
        <br><br>
        Have a wonderful day!
      </p>
    </div>
  </div>

  <div class="screen-notice" id="screenNotice">
    Keep this page open while walking
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Firebase configuration - MUST MATCH alarm-clock.js
    const firebaseConfig = {
      apiKey: "AIzaSyAoiKhzVwLaPyWmO2AP0_TBb3FDh_sax7Q",
      authDomain: "alarmclock-74b53.firebaseapp.com",
      databaseURL: "https://alarmclock-74b53-default-rtdb.firebaseio.com",
      projectId: "alarmclock-74b53",
      storageBucket: "alarmclock-74b53.firebasestorage.app",
      messagingSenderId: "627662344738",
      appId: "1:627662344738:web:90e2fcb1fba21c5de5307b"
    };

    // State
    let pairingCode = '';
    let targetDistance = 100;
    let totalDistance = 0;
    let lastPosition = null;
    let watchId = null;
    let sessionRef = null;
    let wakeLock = null;
    let heartbeatInterval = null;

    // DOM Elements
    const pairingSection = document.getElementById('pairingSection');
    const trackingSection = document.getElementById('trackingSection');
    const successSection = document.getElementById('successSection');
    const connectBtn = document.getElementById('connectBtn');
    const pairingError = document.getElementById('pairingError');
    const trackingError = document.getElementById('trackingError');
    const distanceValue = document.getElementById('distanceValue');
    const distanceCircle = document.getElementById('distanceCircle');
    const targetValue = document.getElementById('targetValue');
    const gpsAccuracy = document.getElementById('gpsAccuracy');
    const screenNotice = document.getElementById('screenNotice');
    const digits = [
      document.getElementById('digit1'),
      document.getElementById('digit2'),
      document.getElementById('digit3'),
      document.getElementById('digit4')
    ];

    // Auto-focus and move between digit inputs
    digits.forEach((digit, index) => {
      digit.addEventListener('input', (e) => {
        const value = e.target.value.replace(/[^0-9]/g, '');
        e.target.value = value;

        if (value && index < 3) {
          digits[index + 1].focus();
        }

        updateConnectButton();
      });

      digit.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
          digits[index - 1].focus();
        }
      });

      digit.addEventListener('paste', (e) => {
        e.preventDefault();
        const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 4);
        pastedData.split('').forEach((char, i) => {
          if (digits[i]) digits[i].value = char;
        });
        updateConnectButton();
        if (pastedData.length === 4) connectBtn.focus();
      });
    });

    function updateConnectButton() {
      const code = digits.map(d => d.value).join('');
      connectBtn.disabled = code.length !== 4;
    }

    // Check URL for pre-filled code
    const urlParams = new URLSearchParams(window.location.search);
    const prefilledCode = urlParams.get('code');
    if (prefilledCode && prefilledCode.length === 4) {
      prefilledCode.split('').forEach((char, i) => {
        if (digits[i]) digits[i].value = char;
      });
      updateConnectButton();
    }

    // Focus first digit on load
    digits[0].focus();

    // Connect button handler
    connectBtn.addEventListener('click', async () => {
      pairingCode = digits.map(d => d.value).join('');

      if (pairingCode.length !== 4) {
        showError(pairingError, 'Please enter a 4-digit code');
        return;
      }

      // Check Firebase config
      if (!firebaseConfig.apiKey) {
        showError(pairingError, 'Firebase not configured. Please add your Firebase config.');
        return;
      }

      connectBtn.disabled = true;
      connectBtn.textContent = 'Connecting...';

      try {
        // Initialize Firebase
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        // Check if session exists
        sessionRef = db.ref(`sessions/${pairingCode}`);
        const snapshot = await sessionRef.get();

        if (!snapshot.exists()) {
          showError(pairingError, 'Invalid code. Check the code on your computer.');
          connectBtn.disabled = false;
          connectBtn.textContent = 'Connect';
          return;
        }

        const sessionData = snapshot.val();
        targetDistance = sessionData.targetDistance || 100;
        targetValue.textContent = targetDistance;

        // Mark as connected
        await sessionRef.update({
          connected: true,
          lastUpdate: Date.now()
        });

        // Start tracking
        startTracking();

      } catch (error) {
        console.error('Connection error:', error);
        showError(pairingError, 'Connection failed: ' + error.message);
        connectBtn.disabled = false;
        connectBtn.textContent = 'Connect';
      }
    });

    async function startTracking() {
      // Show tracking UI
      pairingSection.style.display = 'none';
      trackingSection.classList.add('active');

      // Request wake lock to keep screen on
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          screenNotice.textContent = 'Screen will stay on while tracking';
          screenNotice.classList.add('success');
        }
      } catch (err) {
        console.log('Wake lock failed:', err);
      }

      // Start GPS tracking
      if (!navigator.geolocation) {
        showError(trackingError, 'GPS not available on this device');
        return;
      }

      watchId = navigator.geolocation.watchPosition(
        onPositionUpdate,
        onPositionError,
        {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 10000
        }
      );

      // Start heartbeat
      heartbeatInterval = setInterval(sendHeartbeat, 3000);

      // Listen for session deletion (alarm dismissed from computer)
      sessionRef.on('value', (snapshot) => {
        if (!snapshot.exists()) {
          // Session was deleted - alarm dismissed
          showSuccess();
        }
      });
    }

    function onPositionUpdate(position) {
      const { latitude, longitude, accuracy } = position.coords;

      // Update accuracy display
      gpsAccuracy.textContent = Math.round(accuracy);

      // Calculate distance from last position
      if (lastPosition) {
        const delta = haversineDistance(
          lastPosition.lat, lastPosition.lng,
          latitude, longitude
        );

        // Only count if movement is reasonable (filter GPS jitter)
        // Ignore very small movements (< 1m) and very large jumps (> 50m) which are likely errors
        if (delta >= 1 && delta <= 50) {
          totalDistance += delta;
          updateDistanceDisplay();
          syncToFirebase();
        }
      }

      lastPosition = { lat: latitude, lng: longitude };
    }

    function onPositionError(error) {
      console.error('GPS error:', error);
      let message = 'GPS error: ';

      switch (error.code) {
        case error.PERMISSION_DENIED:
          message += 'Location permission denied. Please allow location access.';
          break;
        case error.POSITION_UNAVAILABLE:
          message += 'Location unavailable. Make sure GPS is enabled.';
          break;
        case error.TIMEOUT:
          message += 'Location request timed out. Trying again...';
          break;
        default:
          message += error.message;
      }

      showError(trackingError, message);
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000; // Earth's radius in meters
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);

      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function toRad(deg) {
      return deg * (Math.PI / 180);
    }

    function updateDistanceDisplay() {
      const displayDistance = Math.round(totalDistance);
      const percentage = Math.min(100, (totalDistance / targetDistance) * 100);

      distanceValue.textContent = displayDistance;
      distanceCircle.style.setProperty('--progress', percentage + '%');

      // Check if target reached
      if (totalDistance >= targetDistance) {
        showSuccess();
      }
    }

    async function syncToFirebase() {
      if (!sessionRef) return;

      try {
        await sessionRef.update({
          totalDistance: totalDistance,
          lastUpdate: Date.now()
        });
      } catch (error) {
        console.error('Sync error:', error);
      }
    }

    function sendHeartbeat() {
      if (!sessionRef) return;

      sessionRef.update({
        connected: true,
        lastUpdate: Date.now()
      }).catch(console.error);
    }

    function showSuccess() {
      // Stop tracking
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }

      // Stop heartbeat
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }

      // Release wake lock
      if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
      }

      // Show success UI
      trackingSection.classList.remove('active');
      successSection.classList.add('active');
      screenNotice.style.display = 'none';
    }

    function showError(element, message) {
      element.textContent = message;
      element.style.display = 'block';
    }

    // Handle page visibility changes (phone locked)
    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible' && wakeLock === null && trackingSection.classList.contains('active')) {
        // Try to reacquire wake lock when page becomes visible again
        try {
          if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
          }
        } catch (err) {
          console.log('Could not reacquire wake lock:', err);
        }
      }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (sessionRef) {
        sessionRef.update({ connected: false });
      }

      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
      }

      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
      }

      if (wakeLock) {
        wakeLock.release();
      }
    });
  </script>
</body>
</html>
